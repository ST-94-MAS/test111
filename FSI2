# 使用するメモリのサイズ（GB単位で指定）
$memorySize = 80 # 必要なサイズに応じて変更します

# メモリ確保開始メッセージ
Write-Output "Memory allocation started..."

# ネイティブメモリを直接確保するための方法
$allocatedMemory = @()

for ($i = 0; $i -lt $memorySize * 1024; $i++) {
    $ptr = [System.Runtime.InteropServices.Marshal]::AllocHGlobal(1MB) # 1MBずつ確保
    [System.Runtime.InteropServices.Marshal]::WriteByte($ptr, 0, 0)  # 確保したメモリを初期化
    $allocatedMemory += $ptr
    Write-Output "Allocated $($i + 1) MB of native memory"
}

# メモリ確保後のメッセージ
Write-Output "Memory allocated successfully. Holding memory..."

# メモリを保持するために停止せずに保持する
Start-Sleep -Seconds 3600

# スクリプト終了メッセージ
Write-Output "Memory allocation test completed."

# メモリ解放処理
foreach ($ptr in $allocatedMemory) {
    [System.Runtime.InteropServices.Marshal]::FreeHGlobal($ptr)
}
Write-Output "Memory freed."
